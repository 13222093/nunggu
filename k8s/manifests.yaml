# ============================================
# KUBERNETES MANIFESTS - NUNGGU/KITA
# Namespace, Deployments, Services, IngressRoutes
# ============================================

---
# ============================================
# Namespace
# ============================================
apiVersion: v1
kind: Namespace
metadata:
  name: nunggu

---
# ============================================
# ConfigMap - Non-sensitive configuration
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nunggu-config
  namespace: nunggu
data:
  NODE_ENV: "production"
  NEXT_PUBLIC_API_URL: "https://api-nunggu.naufarrel.tech"
  # Backend Config
  PORT: "8000"
  NETWORK: "sepolia"
  # Base Sepolia (Testnet)
  BASE_SEPOLIA_RPC: "https://sepolia.base.org"
  MOCK_USDC_ADDRESS: "0x00dcEE3921A5BDf4Baa6bd836D8Bf88cE9cd0bF1"
  MOCK_OPTIONBOOK_ADDRESS: "0x79F320b0b657BfBB20a619600e1Fda721026EB1c"
  KITA_VAULT_ADDRESS_SEPOLIA: "0x1cF7e8fF49cd61D7AAB9850BaC106E0947c31326"
  GROUP_VAULT_ADDRESS_SEPOLIA: "0x9B2b628b1bad3C9983A2E6C0170185d289489c6e"
  # Base Mainnet (Production)
  BASE_MAINNET_RPC: "https://mainnet.base.org"
  KITA_VAULT_ADDRESS_MAINNET: "0x0000000000000000000000000000000000000000"
  GROUP_VAULT_ADDRESS_MAINNET: "0x0000000000000000000000000000000000000000"

---
# ============================================
# Secret - Sensitive configuration
# ============================================
apiVersion: v1
kind: Secret
metadata:
  name: nunggu-secrets
  namespace: nunggu
type: Opaque
stringData:
  DATABASE_URL: "postgresql://nunggu_user:nunggu_password@postgres:5432/nunggu_db?schema=public"
  TELEGRAM_BOT_TOKEN: "dummy-token"
  TELEGRAM_ADMIN_CHAT_ID: ""
  GEMINI_API_KEY: "dummy-token"

---
# ============================================
# Backend Deployment
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nunggu-backend
  namespace: nunggu
  annotations:
    keel.sh/policy: force 
    keel.sh/trigger: poll
    keel.sh/match-tag: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nunggu-backend
  template:
    metadata:
      labels:
        app: nunggu-backend
    spec:
      containers:
        - name: nunggu-backend
          image: reletz/nunggu:backend-latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              name: http
          envFrom:
            - configMapRef:
                name: nunggu-config
            - secretRef:
                name: nunggu-secrets
          resources:
            limits:
              memory: "256Mi"
              cpu: "500m"
            requests:
              memory: "64Mi"
              cpu: "50m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5

---
# ============================================
# Database Seeding Job
# ============================================
apiVersion: batch/v1
kind: Job
metadata:
  name: nunggu-db-seed
  namespace: nunggu
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
        - name: seed
          image: reletz/nunggu:backend-latest
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
            - |
              cd /app && \
              npx prisma generate && \
              npx prisma db push --accept-data-loss && \
              npx tsx prisma/seed.ts
          envFrom:
            - configMapRef:
                name: nunggu-config
            - secretRef:
                name: nunggu-secrets
          resources:
            limits:
              memory: "256Mi"
              cpu: "500m"
            requests:
              memory: "128Mi"
              cpu: "250m"

---
# ============================================
# Backend Service
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: nunggu-backend
  namespace: nunggu
spec:
  type: ClusterIP
  selector:
    app: nunggu-backend
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000

---
# ============================================
# Backend IngressRoute (Traefik)
# ============================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nunggu-backend
  namespace: nunggu
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`api-nunggu.k8s.local`) || Host(`api-nunggu.naufarrel.tech`)
      kind: Rule
      services:
        - name: nunggu-backend
          port: 8000

---
# ============================================
# Frontend Deployment
# ===============================annotations=============
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nunggu-frontend
  namespace: nunggu
  annotations:
    keel.sh/policy: force 
    keel.sh/trigger: poll
    keel.sh/match-tag: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nunggu-frontend
  template:
    metadata:
      labels:
        app: nunggu-frontend
    spec:
      containers:
        - name: nunggu-frontend
          image: reletz/nunggu:frontend-latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_PUBLIC_API_URL
              value: "https://api-nunggu.naufarrel.tech"
          resources:
            limits:
              memory: "256Mi"
              cpu: "500m"
            requests:
              memory: "64Mi"
              cpu: "50m"
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5

---
# ============================================
# Frontend Service
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: nunggu-frontend
  namespace: nunggu
spec:
  type: ClusterIP
  selector:
    app: nunggu-frontend
  ports:
    - protocol: TCP
      port: 3000
      targetPort: 3000

---
# ============================================
# Frontend IngressRoute (Traefik)
# ============================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nunggu-frontend
  namespace: nunggu
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`kita.naufarrel.tech`)
      kind: Rule
      services:
        - name: nunggu-frontend
          port: 3000
